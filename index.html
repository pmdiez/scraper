<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor PRO - EfectoLED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Dise√±o responsivo para tablas en m√≥vil */
        @media (max-width: 768px) {
            .mobile-stack thead { display: none; }
            .mobile-stack tr { 
                display: block; 
                margin-bottom: 1.5rem; 
                border: 1px solid #e5e7eb;
                border-radius: 1rem;
                background: white;
                padding: 1rem;
                shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            }
            .mobile-stack td { 
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f3f4f6;
            }
            .mobile-stack td:last-child { border: none; }
            .mobile-stack td::before {
                content: attr(data-label);
                font-weight: 700;
                color: #6b7280;
                font-size: 0.7rem;
                text-transform: uppercase;
            }
            .mobile-stack .product-cell { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-6">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8">
            <div>
                <h1 class="text-3xl font-black text-gray-900 tracking-tight">EfectoLED Monitor</h1>
                <p id="productCount" class="text-blue-600 font-bold text-sm">üîÑ Cargando cat√°logo completo...</p>
            </div>
            
            <div class="flex w-full md:w-auto gap-3">
                <button onclick="exportToExcel()" id="exportBtn" class="hidden flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg">
                    Descargar Excel
                </button>
                <div id="status" class="flex-1 bg-white px-4 py-2.5 rounded-xl border border-gray-200 text-xs font-bold flex items-center justify-center shadow-sm">
                    ‚è≥ CONECTANDO...
                </div>
            </div>
        </div>

        <div class="relative mb-8">
            <input type="text" id="searchInput" placeholder="Buscar por nombre o referencia..." 
                class="w-full p-5 rounded-2xl shadow-sm border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500 text-lg transition-all">
        </div>

        <div class="overflow-hidden md:bg-white md:rounded-3xl md:shadow-xl md:border md:border-gray-100">
            <table class="w-full mobile-stack">
                <thead class="bg-gray-900 text-white hidden md:table-header-group">
                    <tr>
                        <th class="p-5 text-xs font-black uppercase tracking-widest">Ref</th>
                        <th class="p-5 text-xs font-black uppercase tracking-widest">Producto</th>
                        <th class="p-5 text-xs font-black uppercase tracking-widest text-right">Precio</th>
                        <th class="p-5 text-xs font-black uppercase tracking-widest text-center">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="productTable" class="md:divide-y md:divide-gray-100">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        let allProducts = [];

        async function loadData() {
            try {
                const res = await fetch('/api/scrape');
                const json = await res.json();
                
                if (json.success) {
                    allProducts = json.data;
                    render(allProducts);
                    document.getElementById('status').innerText = '‚úÖ ACTUALIZADO';
                    document.getElementById('productCount').innerText = `üì¶ ${allProducts.length} productos listados (20 p√°ginas)`;
                    document.getElementById('exportBtn').classList.remove('hidden');
                } else {
                    document.getElementById('status').innerText = '‚ùå ERROR API';
                }
            } catch (e) {
                document.getElementById('status').innerText = '‚ùå ERROR RED';
            }
        }

        function render(data) {
            const tbody = document.getElementById('productTable');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-500 font-bold">No se encontraron productos</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(p => `
                <tr class="hover:bg-blue-50/40 transition-colors">
                    <td class="p-4 md:p-5" data-label="Referencia">
                        <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold font-mono border border-blue-100 italic">#${p.ref}</span>
                    </td>
                    <td class="p-4 md:p-5" data-label="Producto">
                        <div class="flex items-center gap-4 text-left w-full">
                            <img src="${p.imagen}" class="w-12 h-12 object-contain border bg-white rounded-xl shadow-sm flex-shrink-0" onerror="this.src='https://via.placeholder.com/60?text=LED'">
                            <span class="text-sm font-bold text-gray-800 leading-tight">${p.nombre}</span>
                        </div>
                    </td>
                    <td class="p-4 md:p-5 text-right" data-label="Precio">
                        <span class="text-xl md:text-lg font-black text-emerald-600">${p.precio}</span>
                    </td>
                    <td class="p-4 md:p-5 text-center" data-label="Acci√≥n">
                        <a href="${p.enlace}" target="_blank" class="w-full md:w-auto block md:inline-block bg-gray-900 text-white px-5 py-2.5 rounded-xl text-xs font-black hover:bg-blue-600 transition-all text-center">WEB</a>
                    </td>
                </tr>
            `).join('');
        }

        function exportToExcel() {
            if (allProducts.length === 0) return;
            const dataToExport = allProducts.map(p => ({
                'REF': p.ref,
                'PRODUCTO': p.nombre,
                'PRECIO': p.precio,
                'URL': p.enlace
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Cat√°logo");
            XLSX.writeFile(wb, `EfectoLED_Export.xlsx`);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            const filtered = allProducts.filter(p => 
                p.nombre.toLowerCase().includes(val) || 
                String(p.ref).toLowerCase().includes(val)
            );
            render(filtered);
        });

        loadData();
    </script>
</body>
</html>
