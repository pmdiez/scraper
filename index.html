<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor PRO - EfectoLED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto py-10 px-4">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-gray-900 tracking-tighter">Monitor de Precios PRO</h1>
                <p id="productCount" class="text-blue-600 font-bold italic">Iniciando escaneo de 20 p√°ginas...</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="exportToExcel()" id="exportBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-bold shadow-lg transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Descargar Excel
                </button>
                
                <div id="status" class="bg-white px-4 py-2 rounded-lg border shadow-sm text-sm font-bold">
                    ‚è≥ Procesando...
                </div>
            </div>
        </div>

        <input type="text" id="searchInput" placeholder="Filtrar por nombre o referencia..." 
            class="w-full p-4 rounded-xl shadow-lg mb-6 outline-none focus:ring-2 focus:ring-blue-500 border-none">

        

        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-4 text-xs uppercase font-black">Ref</th>
                            <th class="p-4 text-xs uppercase font-black">Producto</th>
                            <th class="p-4 text-xs uppercase font-black text-right">Precio</th>
                            <th class="p-4 text-xs uppercase font-black text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="productTable" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allProducts = [];

        async function loadData() {
            try {
                const res = await fetch('/api/scrape');
                const json = await res.json();
                if (json.success) {
                    allProducts = json.data;
                    render(allProducts);
                    
                    document.getElementById('status').innerText = '‚úÖ LISTO';
                    document.getElementById('productCount').innerText = `üì¶ ${allProducts.length} productos cargados (20 p√°ginas)`;
                    
                    // Mostrar bot√≥n de Excel al terminar la carga
                    document.getElementById('exportBtn').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('status').innerText = '‚ùå ERROR';
            }
        }

        // Funci√≥n para Exportar a Excel
        function exportToExcel() {
            if (allProducts.length === 0) return;

            // Preparamos los datos para que el Excel sea legible (limpiamos columnas)
            const dataToExport = allProducts.map(p => ({
                'REFERENCIA': p.ref,
                'NOMBRE PRODUCTO': p.nombre,
                'PRECIO': p.precio,
                'LINK WEB': p.enlace
            }));

            // Creamos el libro de Excel
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Precios_EfectoLED");

            // Ajuste b√°sico de ancho de columnas
            worksheet['!cols'] = [{ wch: 15 }, { wch: 60 }, { wch: 15 }, { wch: 50 }];

            // Descargar el archivo
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `EfectoLED_Precios_${fecha}.xlsx`);
        }

        function render(data) {
            const tbody = document.getElementById('productTable');
            tbody.innerHTML = data.map(p => `
                <tr class="hover:bg-blue-50/30 transition-colors">
                    <td class="p-4 font-mono text-xs font-bold text-blue-600">#${p.ref}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${p.imagen}" class="w-10 h-10 object-contain border bg-white rounded shadow-sm" onerror="this.src='https://via.placeholder.com/50'">
                            <span class="text-sm font-medium text-gray-700">${p.nombre}</span>
                        </div>
                    </td>
                    <td class="p-4 text-right font-black text-green-600 text-lg">${p.precio}</td>
                    <td class="p-4 text-center">
                        <a href="${p.enlace}" target="_blank" class="bg-gray-800 text-white px-3 py-1.5 rounded-md text-[10px] font-bold hover:bg-blue-600 transition-all">WEB</a>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            const filtered = allProducts.filter(p => 
                p.nombre.toLowerCase().includes(val) || 
                String(p.ref).toLowerCase().includes(val)
            );
            render(filtered);
        });

        loadData();
    </script>
</body>
</html>
