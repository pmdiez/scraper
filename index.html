<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor PRO Multi-Tienda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div class="max-w-6xl mx-auto px-4 py-8">
        
        <div class="flex flex-wrap gap-2 mb-8 bg-white p-2 rounded-2xl shadow-sm border border-slate-200">
            <button onclick="changeSite('efectoled')" id="btn-efectoled" class="flex-1 py-3 px-6 rounded-xl font-bold transition-all border-2 border-transparent">
                EfectoLED (Downlights)
            </button>
            <button onclick="changeSite('greenice')" id="btn-greenice" class="flex-1 py-3 px-6 rounded-xl font-bold transition-all border-2 border-transparent">
                GreenIce (Tiras LED)
            </button>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-8">
            <div>
                <h1 id="mainTitle" class="text-4xl font-black text-slate-900 tracking-tighter uppercase">Cargando...</h1>
                <p id="productCount" class="text-slate-500 font-bold mt-1 italic">Conectando con el servidor...</p>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="exportToExcel()" class="flex-1 md:flex-none bg-emerald-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition-all">Excel</button>
                <div id="status" class="flex-1 md:flex-none bg-white px-4 py-3 rounded-2xl border font-black text-xs flex items-center justify-center">⏳ ESPERANDO</div>
            </div>
        </div>

        <input type="text" id="searchInput" placeholder="Filtrar por nombre o referencia..." 
            class="w-full p-5 rounded-3xl shadow-md border-none outline-none focus:ring-4 focus:ring-blue-500/20 text-lg mb-8">

        

        <div class="bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-900 text-white hidden md:table-header-group">
                    <tr>
                        <th class="p-6 text-[10px] uppercase tracking-[0.2em] font-black">Ref</th>
                        <th class="p-6 text-[10px] uppercase tracking-[0.2em] font-black">Producto</th>
                        <th class="p-6 text-[10px] uppercase tracking-[0.2em] font-black text-right">Precio</th>
                        <th class="p-6 text-[10px] uppercase tracking-[0.2em] font-black text-center">Acceso</th>
                    </tr>
                </thead>
                <tbody id="productTable" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentSite = 'efectoled';
        let allProducts = [];

        function updateUI() {
            const isGI = currentSite === 'greenice';
            document.getElementById('mainTitle').innerText = isGI ? 'GreenIce Store' : 'EfectoLED Store';
            
            // Estilos de botones
            const btnEF = document.getElementById('btn-efectoled');
            const btnGI = document.getElementById('btn-greenice');
            
            if (isGI) {
                btnGI.className = "flex-1 py-3 px-6 rounded-xl font-bold bg-green-600 text-white shadow-lg";
                btnEF.className = "flex-1 py-3 px-6 rounded-xl font-bold bg-slate-50 text-slate-400 hover:bg-slate-100";
            } else {
                btnEF.className = "flex-1 py-3 px-6 rounded-xl font-bold bg-blue-600 text-white shadow-lg";
                btnGI.className = "flex-1 py-3 px-6 rounded-xl font-bold bg-slate-50 text-slate-400 hover:bg-slate-100";
            }
        }

        async function changeSite(site) {
            currentSite = site;
            updateUI();
            allProducts = [];
            render([]);
            document.getElementById('status').innerText = '⏳ CARGANDO...';
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/scrape?site=${currentSite}`);
                const json = await res.json();
                if (json.success) {
                    allProducts = json.data;
                    render(allProducts);
                    document.getElementById('status').innerText = '✅ LISTO';
                    document.getElementById('productCount').innerText = `${allProducts.length} productos disponibles`;
                }
            } catch (e) { document.getElementById('status').innerText = '❌ ERROR'; }
        }

        function render(data) {
            const tbody = document.getElementById('productTable');
            tbody.innerHTML = data.map(p => `
                <tr class="hover:bg-slate-50/80 transition-all group">
                    <td class="p-5 font-mono text-xs font-black text-blue-600">#${p.ref}</td>
                    <td class="p-5 flex items-center gap-4">
                        <img src="${p.imagen}" class="w-12 h-12 object-contain bg-white rounded-xl border border-slate-100 shadow-sm group-hover:scale-110 transition-transform" onerror="this.src='https://via.placeholder.com/50'">
                        <span class="text-sm font-bold text-slate-800 leading-tight">${p.nombre}</span>
                    </td>
                    <td class="p-5 text-right font-black text-emerald-600 text-lg">${p.precio}</td>
                    <td class="p-5 text-center">
                        <a href="${p.enlace}" target="_blank" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-blue-600 transition-all">Web</a>
                    </td>
                </tr>
            `).join('');
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(allProducts);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Precios");
            XLSX.writeFile(wb, `Monitor_${currentSite}.xlsx`);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            render(allProducts.filter(p => p.nombre.toLowerCase().includes(val) || String(p.ref).toLowerCase().includes(val)));
        });

        changeSite('efectoled'); // Iniciar con EfectoLED
    </script>
</body>
</html>
